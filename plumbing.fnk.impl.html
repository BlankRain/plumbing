<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>plumbing.fnk.impl documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Plumbing 0.3.3 API documentation</a></h1></div><div class="sidebar" id="namespaces"><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>plumbing</span></div></div></li><li class="depth-2 branch"><a href="plumbing.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fnk</span></div></div></li><li class="depth-3 branch current"><a href="plumbing.fnk.impl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>impl</span></div></a></li><li class="depth-3 branch"><a href="plumbing.fnk.pfnk.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pfnk</span></div></a></li><li class="depth-3"><a href="plumbing.fnk.schema.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>schema</span></div></a></li><li class="depth-2 branch"><a href="plumbing.graph.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>graph</span></div></a></li><li class="depth-2"><a href="plumbing.graph-async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>graph-async</span></div></a></li><li class="depth-3"><a href="plumbing.graph.positional.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>positional</span></div></a></li><li class="depth-2"><a href="plumbing.map.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>map</span></div></a></li></ul></div><div class="sidebar" id="vars"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="plumbing.fnk.impl.html#var-.2Bnone.2B"><div class="inner"><span>+none+</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-efficient-call-forms"><div class="inner"><span>efficient-call-forms</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-ensure-schema-metadata"><div class="inner"><span>ensure-schema-metadata</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-fnk-form"><div class="inner"><span>fnk-form</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-k-.3Esym"><div class="inner"><span>k-&gt;sym</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-letk-arg-bind-sym-and-body-form"><div class="inner"><span>letk-arg-bind-sym-and-body-form</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-letk-input-schema-and-body-form"><div class="inner"><span>letk-input-schema-and-body-form</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-positional-arg-bind-sym-and-body"><div class="inner"><span>positional-arg-bind-sym-and-body</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-positional-arg-bind-syms-and-body"><div class="inner"><span>positional-arg-bind-syms-and-body</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-positional-fn"><div class="inner"><span>positional-fn</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-positional-fnk-form"><div class="inner"><span>positional-fnk-form</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-positional-info"><div class="inner"><span>positional-info</span></div></a></li><li class="depth-1"><a href="plumbing.fnk.impl.html#var-schema-override"><div class="inner"><span>schema-override</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h2 class="anchor" id="top">plumbing.fnk.impl</h2><div class="doc"><pre class="plaintext">Core utilities for parsing our &apos;fnk&apos;-style binding syntax.
Documented and tested through the actual &apos;letk&apos;,&apos;fnk&apos;, and &apos;defnk&apos;
macros in plumbing.core.

The core entry points into this namespace are &apos;letk*&apos; and &apos;fnk*&apos;,
which parse the new binding syntax and generate fnk bodies,
respectively.

For efficiency, two different methods of generating fnk bodies are
used.  If the fnk takes a fixed set of arguments (i.e., no &amp; or
:as), then a &apos;positional&apos; version of the fnk that is called like an
ordinary Clojure fn (e.g., (f a b) rather than (f {:a a :b b}) is
generated as an implementation detail, and stored in metadata of
the actual keyword fnk (which is just a thin wrapper around the
positional version).  If &apos;&amp; or :as are used, no such positional
function is generated.

The advantage of these &apos;positional&apos; functions is that they can be
accessed using &apos;efficient-call-forms&apos; or &apos;positional-fn&apos; to call
the fnk without incurring the overhead of producing and then
destructuring a top-level map.  See plumbing.graph.positional for
an example use.</pre></div><div class="public anchor" id="var-.2Bnone.2B"><h3>+none+</h3><div class="usage"></div><div class="doc"><pre class="plaintext">A sentinel value used to indicate a non-provided optional value in a positional form.
</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L185">view source</a></div></div><div class="public anchor" id="var-efficient-call-forms"><h3>efficient-call-forms</h3><div class="usage"><code>(efficient-call-forms fnk arg-form-map)</code></div><div class="doc"><pre class="plaintext">Get [f arg-forms] that can be used to call a fnk most efficiently, using the
positional version if available, or otherwise the raw fnk.  arg-form-map
is a map from keywords representing arguments to fnk to *forms* that evaluate
to the corresponding arguments.

The basic idea is that (eval (cons f arg-forms)) would yield code for an
efficient call to fnk.  However, this form is not returned directly, because
in most cases the literal function f cannot be directly evaluated due to
a quirk in Clojure -- e.g., try (eval `(~(let [x 1] (fn [y] (+ y x))) 2)).

For examples of how this is used, see &apos;positional-fn&apos; below, or the positional
compilation in plumbing.graph.positional.</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L243">view source</a></div></div><div class="public anchor" id="var-ensure-schema-metadata"><h3>ensure-schema-metadata</h3><div class="usage"><code>(ensure-schema-metadata env x)</code></div><div class="doc"><pre class="plaintext"></pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L51">view source</a></div></div><div class="public anchor" id="var-fnk-form"><h3>fnk-form</h3><div class="usage"><code>(fnk-form env name? bind body)</code></div><div class="doc"><pre class="plaintext">Take an optional name, binding form, and body for a fnk, and make an
IFn/PFnk for these arguments.

For efficiency, two different methods of generating fnk bodies are
used.  If the fnk takes a fixed set of arguments (i.e., no &amp; or
:as), then a &apos;positional&apos; version of the fnk that is called like an
ordinary Clojure fn (e.g., (f a b) rather than (f {:a a :b b}) is
generated as an implementation detail, and stored in metadata of
the actual keyword fnk (which is just a thin wrapper around the
positional version).  If &apos;&amp; or :as are used, no such positional
function is generated.</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L331">view source</a></div></div><div class="public anchor" id="var-k-.3Esym"><h3>k-&gt;sym</h3><div class="usage"><code>(k-&gt;sym k)</code></div><div class="doc"><pre class="plaintext">Make a keyword into a symbol
</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L35">view source</a></div></div><div class="public anchor" id="var-letk-arg-bind-sym-and-body-form"><h3>letk-arg-bind-sym-and-body-form</h3><div class="usage"><code>(letk-arg-bind-sym-and-body-form env map-sym binding key-path body-form)</code></div><div class="doc"><pre class="plaintext">Given a single element of a single letk binding form and a current body form, return
a map {:schema-entry :body-form} where schema-entry is a tuple
[bound-key schema external-schema?], and body-form wraps body with destructuring
for this binding as necessary.</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L71">view source</a></div></div><div class="public anchor" id="var-letk-input-schema-and-body-form"><h3>letk-input-schema-and-body-form</h3><div class="usage"><code>(letk-input-schema-and-body-form env binding-form key-path body-form)</code></div><div class="doc"><pre class="plaintext">Given a single letk binding form, value form, key path, and body
form, return a map {:input-schema :external-input-schema :map-sym :body-form}
where input-schema is the schema imposed by binding-form, external-input-schema
is like input-schema but includes user overrides for binding vectors,
map-sym is the symbol which it expects the bound value to be bound to,
and body-form wraps body in the bindings from binding-form from map-sym.</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L124">view source</a></div></div><div class="public anchor" id="var-positional-arg-bind-sym-and-body"><h3>positional-arg-bind-sym-and-body</h3><div class="usage"><code>(positional-arg-bind-sym-and-body env binding body-form)</code></div><div class="doc"><pre class="plaintext">Given a single element of a fnk binding form and a current body form, return
a pair [[k bind-sym] new-body-form] where bind-sym is a suitable symbol to bind
to k in the fnk arglist (including tag metadata if applicable) and new-body-form
is wrapped with destructuring for this binding as necessary.</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L189">view source</a></div></div><div class="public anchor" id="var-positional-arg-bind-syms-and-body"><h3>positional-arg-bind-syms-and-body</h3><div class="usage"><code>(positional-arg-bind-syms-and-body env bind body-form)</code></div><div class="doc"><pre class="plaintext">Given a fnk binding form and body form, return a pair
[bind-sym-map new-body-form] where bind-sym-map is a map from keyword args
to binding symbols and and new-body-form wraps body to do any extra processing
of nested or optional bindings above and beyond the bindings achieved by
bind-sym-vector.</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L219">view source</a></div></div><div class="public anchor" id="var-positional-fn"><h3>positional-fn</h3><div class="usage"><code>(positional-fn fnk arg-ks)</code></div><div class="doc"><pre class="plaintext">Given argument order in arg-ks, produce an ordinary fn that can be called
with arguments in this order. arg-ks must include all required keys of fnk.

Example: (= ((positional-fn a-fnk [:b :a]) [1 2]) (a-fnk {:a 2 :b 1}))

Can only be applied to fnks with a positional form, and should yield
a function that is significantly faster than calling fnk directly by
avoiding the construction and destructuring of the outer map.  Uses &apos;eval&apos;,
so while the produced function is fast, the actual production of the
positional-fn is generally relatively slow.</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L265">view source</a></div></div><div class="public anchor" id="var-positional-fnk-form"><h3>positional-fnk-form</h3><div class="usage"><code>(positional-fnk-form fn-name external-input-schema ordered-ks-&gt;opt arg-sym-map body)</code></div><div class="doc"><pre class="plaintext">Takes an optional name, input schema, seq of ordered [key optional?] pairs,
an arg-sym-map from these keywords to symbols, and and a positional fn body
that can reference these symbols.
Produces a form generating a IFn/PFnk that can be called as a keyword function,
and has metadata containing the positional function for efficient compilation
as described in &apos;efficient-call-forms&apos; and &apos;positional-fn&apos; above, with
argument order the same as in input-schema by default.   Example:

(def f (eval (i/positional-fnk-form &apos;foo {:x s/Any (s/optional-key :y) s/Any}
                [`(+ ~&apos;x (if (= ~&apos;y i/+none+) 5 ~&apos;y))])))

(= [6 3] [(f {:x 1}) (f {:x 1 :y 2})])
(= [6 3] [((i/positional-fn f [:x]) 1) ((i/positional-fn f [:y :x]) 2 1)]).</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L297">view source</a></div></div><div class="public anchor" id="var-positional-info"><h3>positional-info</h3><div class="usage"><code>(positional-info fnk)</code></div><div class="doc"><pre class="plaintext">If fnk has a positional function implementation, return the pair
[positional-fn positional-arg-ks] such that if positional-arg-ks is [:a :b :c],
calling (positional-fn a b c) is equivalent to calling (fnk {:a a :b b :c c}),
but faster.  Optional values to fnk can be simulated by passing +none+ as the
value, i.e., (positional-fn +none+ b +none) is like (fnk {:b b}).</pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L234">view source</a></div></div><div class="public anchor" id="var-schema-override"><h3>schema-override</h3><div class="usage"><code>(schema-override sym schema)</code></div><div class="doc"><pre class="plaintext"></pre></div><div class="src-link"><a href="http://github.com/prismatic/plumbing/blob/master/src/plumbing/fnk/impl.clj#L54">view source</a></div></div></div></body></html>